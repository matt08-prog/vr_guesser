<!DOCTYPE html>
<html lang="en">
  <head>
    <title>three.js vr - panorama</title>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=no"
    />
    <link type="text/css" rel="stylesheet" href="main.css" />
  </head>
  <script
    src="https://code.jquery.com/jquery-3.6.0.min.js"
    integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4="
    crossorigin="anonymous"
  ></script>
  <!-- jquery -->
  <script src="https://cdn.rawgit.com/adriancooney/console.image/c9e6d4fd/console.image.min.js"></script>
  <!-- jpg merger -->
  <script src="https://unpkg.com/merge-images"></script>
  <body>
    <image
      src="https://maps.googleapis.com/maps/api/streetview?size=600x300&location=46.414382,10.013988&heading=0.01&pitch=-0.76&key=AIzaSyCdksRwVLOQCqlPF1qXBfAXQwyuKfFdI7s"
      class="img1"
    ></image>

    <image
      src="https://maps.googleapis.com/maps/api/streetview?size=600x300&location=46.414382,10.013988&heading=180.01&pitch=-0.76&key=AIzaSyCdksRwVLOQCqlPF1qXBfAXQwyuKfFdI7s"
      class="img2"
    ></image>

    <script type="module">
      import * as THREE from "./build/three.module.js";
      import { VRButton } from "./jsm/webxr/VRButton.js";

      let camera;
      let renderer;
      let scene;
      let loadedImage = false;

      //init();
      //animate();

      let url1 =
        "https://maps.googleapis.com/maps/api/streetview?size=600x300&location=46.414382,10.013988&heading=0.01&pitch=-0.76&key=AIzaSyCdksRwVLOQCqlPF1qXBfAXQwyuKfFdI7s";
      let url2 =
        "https://maps.googleapis.com/maps/api/streetview?size=600x300&location=46.414382,10.013988&heading=180.01&pitch=-0.76&key=AIzaSyCdksRwVLOQCqlPF1qXBfAXQwyuKfFdI7s";

      let base = "data:image/png;base64,";
      let b641;
      let b642;

      function getBase64Image(img) {
        img.setAttribute("crossOrigin", "anonymous");
        var canvas = document.createElement("canvas");
        canvas.width = img.width;
        canvas.height = img.height;
        var ctx = canvas.getContext("2d");
        ctx.drawImage(img, 0, 0);
        var dataURL = canvas.toDataURL("image/png");
        return dataURL;
      }

      b641 = getBase64Image(document.querySelector(".img1"));
      b642 = getBase64Image(document.querySelector(".img2"));

      console.log(b641);
      console.log(b642);

      mergeImages([
        { src: url1, x: 0, y: 0 },
        { src: url2, x: 0, y: 500 },
      ]).then((b64) => {
        document.querySelector("img").src = "data:image/png;base64," + b64;
        console.log("data:image/png;base64," + b64);
      });

      function init() {
        console.log("loading");

        renderer = new THREE.WebGLRenderer();
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.xr.enabled = true;
        renderer.xr.setReferenceSpaceType("local");
        document.body.appendChild(renderer.domElement);

        document.body.appendChild(VRButton.createButton(renderer));

        //

        scene = new THREE.Scene();

        camera = new THREE.PerspectiveCamera(
          70,
          window.innerWidth / window.innerHeight,
          1,
          1000
        );
        camera.layers.enable(1);

        const geometry = new THREE.BoxGeometry(100, 100, 100);
        geometry.scale(1, 1, -1);

        if (loadedImage) {
          const textures = getTexturesFromAtlasFile(
            "textures/cube/sun_temple_stripe_stereo.jpg",
            12
          );

          const materials = [];

          for (let i = 0; i < 6; i++) {
            materials.push(new THREE.MeshBasicMaterial({ map: textures[i] }));
          }

          const skyBox = new THREE.Mesh(geometry, materials);
          skyBox.layers.set(1);
          scene.add(skyBox);

          const materialsR = [];

          for (let i = 6; i < 12; i++) {
            materialsR.push(new THREE.MeshBasicMaterial({ map: textures[i] }));
          }

          const skyBoxR = new THREE.Mesh(geometry, materialsR);
          skyBoxR.layers.set(2);
          scene.add(skyBoxR);
        }

        window.addEventListener("resize", onWindowResize);
      }

      function getTexturesFromAtlasFile(atlasImgUrl, tilesNum) {
        const textures = [];

        for (let i = 0; i < tilesNum; i++) {
          textures[i] = new THREE.Texture();
        }

        const loader = new THREE.ImageLoader();
        loader.load(atlasImgUrl, function (imageObj) {
          let canvas, context;
          const tileWidth = imageObj.height;

          for (let i = 0; i < textures.length; i++) {
            canvas = document.createElement("canvas");
            context = canvas.getContext("2d");
            canvas.height = tileWidth;
            canvas.width = tileWidth;
            context.drawImage(
              imageObj,
              tileWidth * i,
              0,
              tileWidth,
              tileWidth,
              0,
              0,
              tileWidth,
              tileWidth
            );
            textures[i].image = canvas;
            textures[i].needsUpdate = true;
          }
        });

        return textures;
      }

      function onWindowResize() {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();

        renderer.setSize(window.innerWidth, window.innerHeight);
      }

      function animate() {
        renderer.setAnimationLoop(render);
      }

      function render() {
        renderer.render(scene, camera);
      }
    </script>
  </body>
</html>
